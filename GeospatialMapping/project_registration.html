<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Registration</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body {
            display: flex;
            flex-wrap: wrap; /* Allows wrapping for smaller screens */
            justify-content: flex-start;
            align-items: flex-start;
            padding: 20px;
        }

        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 300px;
            text-align: center;
        }

        input {
            width: 80%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 16px;
            text-align: center;
        }

        button {
            width: 50%;
            padding: 10px;
            background-color: #4285F4;
            color: white;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
            margin-top: 10px;
        }

        button:hover {
            background-color: #357ae8;
        }

        #qrcode-container {
            display: none;
            padding: 30px;
            background-color: white;
            text-align: center;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: fit-content;
            margin: 0 20px 20px 0;
        }

        #toggle-qr-button {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #4285F4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #toggle-qr-button:hover {
            background-color: #357ae8;
        }

        #qrcode {
            padding: 20px;
        }

        #map-container {
            width: 60%;
            height: 600px;
            background-color: #f0f0f0;
            margin-left: auto;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        #go-to-index-button {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px; /* Space below the button */
            background-color: #4CAF50; /* Green color */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #go-to-index-button:hover {
            background-color: #45a049; /* Darker green on hover */
        }

    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyActDT3BMeqymgsIrLQb6KgfL83k63caQY"></script>
</head>
<body>
    <div class="container" id="form-container">
        <h2>פרטי הפרויקט</h2>
        <form id="project-form">
            <input type="text" id="project-name" placeholder="שם הפרויקט" required>
            <input type="text" id="project-address" placeholder="כתובת הפרויקט" required>
            <div style="display: center; gap: 10px;">
                <input type="text" id="project-code" placeholder="קוד פרוייקט" required readonly>
                <button type="button" id="generate-code-button">Generate Code</button>
            </div>
            <button type="submit">המשך</button>
        </form>
    </div>


    <div id="qrcode-container">
        <button id="toggle-qr-button">Display QR</button>
        <button id="go-to-index-button" style="display: none;">המשך למפת המשתמש</button>
        <div id="qrcode"></div>
    </div>

    <div id="map-container"></div>

    <script>
        function initMap() {
            const map = new google.maps.Map(document.getElementById("map-container"), {
                center: { lat: 31.7683, lng: 35.2137 }, // Centered in Jerusalem, Israel
                zoom: 8,
            });
        }

        document.addEventListener("DOMContentLoaded", initMap);

        async function geocodeAddress(address) {
            try {
                if (!address.trim()) {
                    alert("Please enter a valid address.");
                    return null;
                }
                const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=AIzaSyActDT3BMeqymgsIrLQb6KgfL83k63caQY`);
                const data = await response.json();
                console.log("Geocoding API Response:", data); // Log the full response
                if (data.status === "OK" && data.results.length > 0) {
                    const location = data.results[0].geometry.location;
                    return { lat: location.lat, lng: location.lng };
                } else {
                    console.error("Geocoding API Error:", data.status, data.error_message || "Unknown error");
                    alert(`Error: ${data.status}. ${data.error_message || "Address not found."}`);
                    return null;
                }
            } catch (error) {
                console.error("Geocoding error:", error);
                alert("Unable to find the location for the entered address. Please check the address and try again.");
                return null;
            }
        }



        document.getElementById('project-form').addEventListener('submit', async function(event) {
            event.preventDefault();

            const projectName = document.getElementById('project-name').value;
            const projectAddress = document.getElementById('project-address').value;
            const projectCode = document.getElementById('project-code').value;

            // Fetch the coordinates for the entered address
            const coordinates = await geocodeAddress(projectAddress);
            try {
                // Send data to the backend
                const response = await fetch("/save_project/",  {
                //const response = await fetch("http://127.0.0.1:8000/save_project/", { // For Debug
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: projectName,
                        address: projectAddress,
                        code: projectCode
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    // Center the map on the geocoded location
                    const map = new google.maps.Map(document.getElementById("map-container"), {
                        center: coordinates,
                        zoom: 14 // Adjust zoom level
                    });

                    new google.maps.Marker({
                        position: coordinates,
                        map: map,
                        title: projectAddress
                    });

                    // Hide the form container
                    document.getElementById('form-container').style.display = 'none';

                    // Show the QR container and initialize the buttons
                    const qrContainer = document.getElementById('qrcode-container');
                    const qrCodeDiv = document.getElementById('qrcode');
                    const displayButton = document.getElementById('toggle-qr-button');
                    const goToIndexButton = document.getElementById('go-to-index-button');

                    qrContainer.style.display = 'block'; // Show the container
                    qrCodeDiv.innerHTML = ''; // Clear existing QR code

                    let isQRVisible = false; // State to track QR visibility
                    displayButton.textContent = "Display QR"; // Initialize button text

                    // QR Toggle Button
                    displayButton.onclick = function () {
                        if (!isQRVisible) {
                            // Generate and show the QR code
                            const baseUrl = window.location.origin;
                            const indexUrl = `${baseUrl}/index/?projectCode=${encodeURIComponent(projectCode)}`;
                            new QRCode(qrCodeDiv, {
                                text: indexUrl,
                                width: 400,
                                height: 400
                            });
                            displayButton.textContent = "Hide QR";
                        } else {
                            // Hide the QR code
                            qrCodeDiv.innerHTML = '';
                            displayButton.textContent = "Display QR";
                        }
                        isQRVisible = !isQRVisible; // Toggle state
                    };

                    // Show the "Go to Index" button
                    goToIndexButton.style.display = "block";
                    goToIndexButton.onclick = function () {
                        // Redirect to index.html with project code
                        const baseUrl = window.location.origin;
                        //const baseUrl = "http://127.0.0.1:8000"; // For Debug
                        const redirectUrl = `${baseUrl}/index/?projectCode=${encodeURIComponent(projectCode)}`;
                        window.location.href = redirectUrl;
                    };
                } else {
                    alert(result.detail || "Error saving project.");
                }
            } catch (error) {
                alert("An error occurred while saving the project.");
                console.error(error);
            }
        });

        document.getElementById('generate-code-button').addEventListener('click', async function () {
            try {
                const response = await fetch("/generate_project_code/");
                //const response = await fetch("http://127.0.0.1:8000/generate_project_code/");   // for Debug
                const data = await response.json();

                if (response.ok && data.project_code) {
                    document.getElementById('project-code').value = data.project_code; // Set the generated code in the input field
                } else {
                    alert(data.detail || "Failed to generate project code.");
                }
            } catch (error) {
                alert("An error occurred while generating the project code.");
                console.error(error);
            }
        });


    </script>
</body>
</html>