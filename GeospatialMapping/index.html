<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <title>Google Maps with Questions</title>

    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #question-container {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            padding: 10px;
            background-color: #f8f9fa;
            z-index: 1;
        }
        #map { 
            height: 85vh; 
            width: 100%; 
            position: relative; 
        }

        .approve-marker-btn {
            background-color: #28a745; /* Professional green color */
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px; /* Increased size for better visibility */
            height: 45px;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: absolute;
            transform: translate(-50%, -50%);
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2); /* Adds depth */
            transition: all 0.2s ease-in-out;
        }

        .approve-marker-btn:hover {
            background-color: #218838; /* Darker green on hover */
            transform: translate(-50%, -50%) scale(1.1); /* Slight scaling effect */
        }

        .approve-marker-btn:active {
            background-color: #1e7e34; /* Even darker on click */
            transform: translate(-50%, -50%) scale(0.95); /* Small shrink effect */
        }

        #approve-btn {
            position: absolute;
            bottom: 3px;
            left: 52%;
            transform: translateX(-50%);
            background-color: #00BFFF;
            color: black;
            border: none;
            padding: 10px 20px;
            font-size: 20px;
            cursor: pointer;
            border-radius: 5px;
            z-index: 2;
        }
        #search-box {
            position: absolute;
            top: 50px;
            right: 0px;
            z-index: 10;
            background-color: white;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 24px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #search-box input {
            border: none;
            outline: none;
            padding: 2px 10px;
            font-size: 17px;
            width: 180px;
            font-family: Arial, sans-serif;
            border-radius: 20px;
        }
        #search-box input::placeholder {
            color: #aaa;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Question Container -->
    <div id="question-container">Loading...</div>

    <!-- Search Box -->
    <div id="search-box">
        <input id="pac-input" type="text" placeholder="Google ×—×™×¤×•×© ×‘××¤×•×ª">
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Approve Button -->
    <button id="approve-btn"> ×”×•×¡×¤×ª ×”××™×§×•×</button>

    <div class="error-message" id="error-message" style="display: none;"></div>

    <script>
        const questions = [
            { key: "FOOD", text: "?××™×¤×” ××ª× ×¢×•×©×™× ×§× ×™×•×ª ×©×œ ××•×¦×¨×™ ××–×•×Ÿ" },
            { key: "FASHION", text: "?××™×¤×” ××ª× ×§×•× ×™× ×‘×’×“×™×" },
            { key: "NIGHTLIFE_AND_FUN", text: "?××™×¤×” ××ª× ×™×•×¦××™× ×œ×‘×œ×•×ª" },
            { key: "KINDERGARTEN", text: "?××™×¤×” ×”×’×Ÿ ×™×œ×“×™×" },
            { key: "SCHOOL", text: "?××™×¤×” ×”×‘×™×ª ×¡×¤×¨" },
            { key: "RELIGION", text: "?××™×¤×” ×”×‘×™×ª ×›× ×¡×ª" }
        ];

        let currentQuestionIndex = 0;
        let map, marker = null;
        let searchBox;
        let selectedCoordinates = { latitude: null, longitude: null, name: null };
        let projectCode = null; 
        let approveBtn = null; 

        // Fetch project details and initialize the map
        async function fetchProjectCode() {
            try {
                projectCode = getQueryParameter('projectCode');
                if (!projectCode) {
                    alert("Error: Missing project code. Please contact the administrator.");
                    throw new Error("Missing project code in URL");
                }
                // Initialize the map after fetching project code
                initMap();
            } catch (error) {
                console.error("Error fetching project code:", error);
            }
        }

        function getQueryParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        // ğŸ“ Set marker on the map
        function setMarkerAtLocation(location, name = "Selected Location") {
            createApproveButton(); // Ensure the button is created
            if (marker) marker.setMap(null); // Remove previous marker if any

            // Create a new marker at the clicked location
            marker = new google.maps.Marker({
                map: map,
                position: location,
                title: name
            });

            // Position the approve button next to the marker
            positionApproveButton(location);
        }

        // Handle map click - place marker & fetch location details
        function handleMapClick(event) {
            const clickedLocation = event.latLng;
            if (!clickedLocation || isNaN(clickedLocation.lat()) || isNaN(clickedLocation.lng())) {
                console.error("âŒ Invalid location detected in handleMapClick()");
                return;
            }

            // Reset selectedCoordinates
            selectedCoordinates = {
                latitude: clickedLocation.lat(),
                longitude: clickedLocation.lng(),
                name: "Retrieving address..."
            };

            // Remove previous marker
            if (window.currentMarker) {
                window.currentMarker.setMap(null);
            }

            if (window.approveBtn) {
                window.approveBtn.remove();
            }

            if (approveBtn) {
                approveBtn.remove();
                approveBtn = null;
            }

            // Place a new marker
            window.currentMarker = new google.maps.Marker({
                position: clickedLocation,
                map: map,
                title: "Selected Location"
            });

            // Create a small green âœ” button next to the marker
            if (!approveBtn) {
                approveBtn = document.createElement("button");
                approveBtn.innerHTML = '<i class="fas fa-check"></i>';
                approveBtn.classList.add("approve-marker-btn");
                document.getElementById("map").appendChild(approveBtn);
            }

            // Position the button correctly
            setTimeout(() => {
                positionApproveButton(clickedLocation);
            }, 100); // Small delay to ensure map updates

            // Click event for saving location
            approveBtn.onclick = approvePoint;

            console.log("ğŸ“ Clicked Location:", selectedCoordinates.latitude, selectedCoordinates.longitude);

            // 1ï¸âƒ£ Try Google Places API first
            getAddressFromPlaceAPI(selectedCoordinates.latitude, selectedCoordinates.longitude);
            
            // 2ï¸âƒ£ If Google Places API fails, use Geocoding API
            setTimeout(() => {
                if (selectedCoordinates.name === "Retrieving address...") {
                    console.warn("âš ï¸ Places API took too long. Trying Geocoder...");
                    fallbackToGeocoder(clickedLocation);
                }
            }, 3000); // Wait 3 seconds for Google Places API

            // 3ï¸âƒ£ If Geocoder also fails, try OpenStreetMap
            setTimeout(() => {
                if (selectedCoordinates.name === "Retrieving address...") {
                    console.warn("âš ï¸ Geocoder took too long. Trying OpenStreetMap...");
                    fetchAlternativeGeocode(selectedCoordinates.latitude, selectedCoordinates.longitude);
                }
            }, 6000); // Wait 6 seconds total
        }


        function getAddressFromPlaceAPI(lat, lng) {
            const service = new google.maps.places.PlacesService(map);

            const request = {
                query: `${lat}, ${lng}`,
                fields: ["formatted_address"],
            };

            service.findPlaceFromQuery(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
                    selectedCoordinates.name = results[0].formatted_address; // âœ… Store full address
                    console.log("âœ… Found address via Places API:", selectedCoordinates.name);
                } else {
                    console.warn("âš ï¸ Places API failed. Trying Geocoder...");
                    fallbackToGeocoder({ lat: () => lat, lng: () => lng }); // âœ… Use Google Geocoder
                }
            });
        }

        // Fallback method if nearbySearch fails
        function fallbackToGeocoder(location) {
            if (!location || isNaN(location.lat()) || isNaN(location.lng())) {
                console.error("âŒ Invalid location passed to fallbackToGeocoder()");
                return;
            }

            const geocoder = new google.maps.Geocoder();

            geocoder.geocode({ location }, (results, status) => {
                if (status === "OK" && results.length > 0) {
                    selectedCoordinates.name = results[0].formatted_address;
                    console.log("âœ… Reverse geocoded:", selectedCoordinates.name);
                } else {
                    console.error("âŒ Geocoder failed. Trying OpenStreetMap...");
                    fetchAlternativeGeocode(location.lat(), location.lng());
                }
            });
        }


        function fetchAlternativeGeocode(lat, lng) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.display_name) {
                        selectedCoordinates.name = data.display_name; // âœ… Use OpenStreetMap address
                        console.log("âœ… OSM Reverse Geocoded:", selectedCoordinates.name);
                    } else {
                        console.warn("âš ï¸ OSM could not find address. Using lat/lng.");
                        selectedCoordinates.name = `Lat: ${lat}, Lng: ${lng}`;
                    }
                })
                .catch(error => {
                    console.error("âŒ OpenStreetMap API Error:", error);
                    selectedCoordinates.name = `Lat: ${lat}, Lng: ${lng}`; // âœ… Final fallback
                });
        }


        function createApproveButton() {
            // Create the button only once
            if (!approveBtn) {
                approveBtn = document.createElement("button");
                approveBtn.innerHTML = "âœ”"; // Green V button
                approveBtn.classList.add("approve-marker-btn");

                // Append it directly to the map container
                document.getElementById("map").appendChild(approveBtn);
            }
        }

        function positionApproveButton(location) {
            // Use OverlayView for correct position calculation
            const overlay = new google.maps.OverlayView();

            overlay.onAdd = function () {
                const layer = this.getPanes().overlayMouseTarget;
                layer.appendChild(approveBtn); // Attach the button to the overlay pane
            };

            overlay.draw = function () {
                const projection = this.getProjection();
                if (!projection) return;

                // Calculate position based on LatLng
                const position = projection.fromLatLngToDivPixel(location);

                // Adjust button position relative to the marker
                approveBtn.style.position = "absolute";
                approveBtn.style.left = `${position.x}px`;
                approveBtn.style.top = `${position.y}px`;
                approveBtn.style.transform = "translate(-50%, -50%)"; // Center the button
                approveBtn.style.zIndex = 100; // Ensure the button stays on top of map layers
                approveBtn.style.pointerEvents = "auto"; // Enable button click events

                // Set visibility to ensure the button is always visible and functional
                approveBtn.style.display = "block";
            };

            overlay.setMap(map); // Attach to the map to make it positionable
        }



        // âœ… Approve & Save selected location
        function approvePoint() {
            if (!selectedCoordinates.latitude || !selectedCoordinates.longitude) {
                alert("×× × ×‘×—×¨ ××™×§×•× ×¢×œ ×”××¤×”.");
                return;
            }

            const currentQuestion = questions[currentQuestionIndex];

            fetch("/save_location/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    latitude: selectedCoordinates.latitude,
                    longitude: selectedCoordinates.longitude,
                    name: selectedCoordinates.name,
                    location_type: currentQuestion.key,
                    project_code: projectCode
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log("ğŸ“Œ Saved:", data);
                Swal.fire({
                    icon: "success",
                    title: "×ª×•×“×”!",
                    text: "×”××™×§×•× × ×©××¨!",
                    confirmButtonText: "××™×©×•×¨"
                });

                currentQuestionIndex++;
                updateQuestion();

                // Reset selected coordinates and clear marker
                selectedCoordinates = { latitude: null, longitude: null, name: null };
                if (window.currentMarker) window.currentMarker.setMap(null);
                document.getElementById("pac-input").value = "";
            })
            .catch(error => {
                console.error("âŒ Error saving data:", error);
                alert("There was an error saving the location.");
            });
        }

        function updateQuestion() {
            if (currentQuestionIndex < questions.length) {
                document.getElementById("question-container").innerText = questions[currentQuestionIndex].text;
            } else {
                document.getElementById("question-container").innerText = "Thank You";
                document.getElementById("approve-btn").style.display = "none";
                setTimeout(() => {
                    try {
                        window.close(); // Try closing normally

                        // If close fails, force close by opening an empty page
                        window.open("about:blank", "_self").close();
                    } catch (e) {
                        console.error("Window close failed:", e);
                        window.location.href = "about:blank"; // As a last resort, redirect
                    }
                }, 2000);
            }
        }

        // Initialize Google Map
        /*
        async function initMap() {
            console.log("Initializing map...");

            // Fetch project details using the project code
            const project = await fetchProjectDetails(projectCode);
            if (!project || !project.address) return;

            // Geocode the project address
            const coordinates = await geocodeAddress(project.address);
            if (!coordinates) return;

            // Initialize the map
            
            map = new google.maps.Map(document.getElementById("map"), {
                //center: { lat: 31.7683, lng: 35.2137 }, // Default center
                center: coordinates,
                zoom: 14
            });
            
            window.initialMarker = new google.maps.Marker({
                position: coordinates,
                map: map,  // âœ… Use `map` instead of `window.map`
                title: "Project Location",
                icon: {
                    url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                }
            });

            // Add click event listener to the map.
            map.addListener("click", handleMapClick);

            // Attach the search box
            const input = document.getElementById("pac-input");
            searchBox = new google.maps.places.SearchBox(input);

            updateQuestion();

            // Bias the SearchBox results towards the current map view
            /*
            map.addListener("bounds_changed", () => {
                searchBox.setBounds(map.getBounds());
            });
            */
           /*
            // Listen for search results
            searchBox.addListener("places_changed", () => {
                const places = searchBox.getPlaces();
                if (places.length === 0) return;
                const place = places[0];

                // Remove previous marker and button
                if (window.currentMarker) {
                    window.currentMarker.setMap(null);
                }

                // Remove previous Approve button
                if (window.approveBtn) {
                    window.approveBtn.remove();
                }
                if (approveBtn) {
                    approveBtn.remove();
                    approveBtn = null;
                }
                setMarkerAtLocation(place.geometry.location, place.name || "Searched Location");

                // Update the map to zoom and center on the place
                map.panTo(place.geometry.location);
                map.setZoom(15);

                // Store selected coordinates and name
                selectedCoordinates.latitude = place.geometry.location.lat();
                selectedCoordinates.longitude = place.geometry.location.lng();
                selectedCoordinates.name = place.name || "Unnamed Location";
                   
                // Create the small green âœ” button
                if (!approveBtn) {
                    approveBtn = document.createElement("button");
                    approveBtn.innerHTML = "âœ”";
                    approveBtn.classList.add("approve-marker-btn");
                    document.getElementById("map").appendChild(approveBtn);
                }
                
                // Position the button after a small delay to ensure the map has updated
                setTimeout(() => {
                    positionApproveButton(place.geometry.location);
                }, 300); // Delay ensures Google Maps has updated before positioning

                // Click event for saving location
                approveBtn.onclick = approvePoint;
            });

            // Click event for saving location
            approveBtn.onclick = approvePoint;

            // Center map on the searched location
            map.panTo(place.geometry.location);
            map.setZoom(15);

            // Add event listener for approve button
            document.getElementById("approve-btn").addEventListener("click", approvePoint);
         
        }
        */
        function initMap() {
            console.log("Initializing map...");

            // Fetch project details using the project code
            fetchProjectDetails(projectCode)
                .then(project => {
                    if (!project || !project.address) return;

                    // Geocode the project address
                    return geocodeAddress(project.address);
                })
                .then(coordinates => {
                    if (!coordinates) return;

                    // Initialize the map
                    map = new google.maps.Map(document.getElementById("map"), {
                        center: coordinates,
                        zoom: 14
                    });

                    // Initial marker for project location
                    window.initialMarker = new google.maps.Marker({
                        position: coordinates,
                        map: map,
                        title: "Project Location",
                        icon: {
                            url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                        }
                    });

                    // Add click event listener to the map
                    map.addListener("click", handleMapClick);

                    // Attach the search box
                    const input = document.getElementById("pac-input");
                    searchBox = new google.maps.places.SearchBox(input);

                    updateQuestion();

                    // Listen for search box results
                    searchBox.addListener("places_changed", () => {
                        const places = searchBox.getPlaces();
                        if (places.length === 0) return;
                        const place = places[0];

                        // Remove previous marker and button
                        if (window.currentMarker) window.currentMarker.setMap(null);
                        if (window.approveBtn) window.approveBtn.remove();
                        if (approveBtn) {
                            approveBtn.remove();
                            approveBtn = null;
                        }

                        setMarkerAtLocation(place.geometry.location, place.name || "Searched Location");

                        // Update the map to zoom and center on the place
                        map.panTo(place.geometry.location);
                        map.setZoom(15);

                        // Store selected coordinates and name
                        selectedCoordinates.latitude = place.geometry.location.lat();
                        selectedCoordinates.longitude = place.geometry.location.lng();
                        selectedCoordinates.name = place.name ? `${place.name}, ${place.formatted_address}` : place.formatted_address;
                        console.log("ğŸ“ Selected Location:", selectedCoordinates.name);

                        // Create the approve button
                        if (!approveBtn) {
                            approveBtn = document.createElement("button");
                            approveBtn.innerHTML = "âœ”";
                            approveBtn.classList.add("approve-marker-btn");
                            document.getElementById("map").appendChild(approveBtn);
                        }

                        // Position the button after a small delay
                        setTimeout(() => {
                            positionApproveButton(place.geometry.location);
                        }, 100);

                        // Click event for saving location
                        approveBtn.onclick = approvePoint;
                    });

                    // Click event for saving location
                    document.getElementById("approve-btn").addEventListener("click", approvePoint);
                })
                .catch(error => {
                    console.error("Error initializing map:", error);
                });
        }

        async function fetchProjectDetails(code) {
            try {
                // Fetch project details from the backend
                const response = await fetch(`/get_project/${code}`);
                //const response = await fetch(`http://127.0.0.1:8000/get_project/${code}`);  //For Debug
                if (!response.ok) throw new Error("Failed to fetch project details.");
                return await response.json();
            } catch (error) {
                console.error("Error fetching project details:", error);
                document.getElementById("error-message").style.display = "block";
                document.getElementById("error-message").textContent = "Failed to fetch project details. Please try again.";
                return null;
            }
        }

        async function geocodeAddress(address) {
            try {
                // Use the Google Geocoding API to get coordinates
                const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=AIzaSyActDT3BMeqymgsIrLQb6KgfL83k63caQY`);
                const data = await response.json();
                if (data.status === "OK" && data.results.length > 0) {
                    return data.results[0].geometry.location; // { lat, lng }
                } else {
                    throw new Error(data.error_message || "Address not found.");
                }
            } catch (error) {
                console.error("Error geocoding address:", error);
                document.getElementById("error-message").style.display = "block";
                document.getElementById("error-message").textContent = "Unable to locate the project address. Please check the details.";
                return null;
            }
        }

        // Fetch the latest project code and initialize map
        document.addEventListener('DOMContentLoaded', fetchProjectCode);
        
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyActDT3BMeqymgsIrLQb6KgfL83k63caQY&libraries=places&callback=initMap" async defer></script>
</body>
</html>