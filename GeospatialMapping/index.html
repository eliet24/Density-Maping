<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps with Questions</title>

    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #question-container {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            padding: 10px;
            background-color: #f8f9fa;
            z-index: 1;
        }
        #map { 
            height: 85vh; 
            width: 100%; 
            position: relative; 
        }
        .approve-marker-btn {
            background-color: green;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: absolute;
            transform: translate(-50%, -50%);
        }
        #approve-btn {
            position: absolute;
            bottom: 3px;
            left: 52%;
            transform: translateX(-50%);
            background-color: #00BFFF;
            color: black;
            border: none;
            padding: 10px 20px;
            font-size: 20px;
            cursor: pointer;
            border-radius: 5px;
            z-index: 2;
        }
        #search-box {
            position: absolute;
            top: 50px;
            right: 0px;
            z-index: 10;
            background-color: white;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 24px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #search-box input {
            border: none;
            outline: none;
            padding: 2px 10px;
            font-size: 17px;
            width: 180px;
            font-family: Arial, sans-serif;
            border-radius: 20px;
        }
        #search-box input::placeholder {
            color: #aaa;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Question Container -->
    <div id="question-container">Loading...</div>

    <!-- Search Box -->
    <div id="search-box">
        <input id="pac-input" type="text" placeholder="Google ◊ó◊ô◊§◊ï◊© ◊ë◊û◊§◊ï◊™">
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Approve Button -->
    <button id="approve-btn"> ◊î◊ï◊°◊§◊™ ◊î◊û◊ô◊ß◊ï◊ù</button>

    <div class="error-message" id="error-message" style="display: none;"></div>

    <script>
        const questions = [
            { key: "FOOD", text: "?◊ê◊ô◊§◊î ◊ê◊™◊ù ◊¢◊ï◊©◊ô◊ù ◊ß◊†◊ô◊ï◊™ ◊©◊ú ◊û◊ï◊¶◊®◊ô ◊û◊ñ◊ï◊ü" },
            { key: "FASHION", text: "?◊ê◊ô◊§◊î ◊ê◊™◊ù ◊ß◊ï◊†◊ô◊ù ◊ë◊í◊ì◊ô◊ù" },
            { key: "NIGHTLIFE_AND_FUN", text: "?◊ê◊ô◊§◊î ◊ê◊™◊ù ◊ô◊ï◊¶◊ê◊ô◊ù ◊ú◊ë◊ú◊ï◊™" },
            { key: "KINDERGARTEN", text: "?◊ê◊ô◊§◊î ◊î◊í◊ü ◊ô◊ú◊ì◊ô◊ù" },
            { key: "SCHOOL", text: "?◊ê◊ô◊§◊î ◊î◊ë◊ô◊™ ◊°◊§◊®" },
            { key: "RELIGION", text: "?◊ê◊ô◊§◊î ◊î◊ë◊ô◊™ ◊õ◊†◊°◊™" }
        ];

        let currentQuestionIndex = 0;
        let map, marker = null;
        let searchBox;
        let selectedCoordinates = { latitude: null, longitude: null, name: null };
        let projectCode = null; 
        let approveBtn = null; 

        // Fetch project details and initialize the map
        async function fetchProjectCode() {
            try {
                projectCode = getQueryParameter('projectCode');
                if (!projectCode) {
                    alert("Error: Missing project code. Please contact the administrator.");
                    throw new Error("Missing project code in URL");
                }
                // Initialize the map after fetching project code
                initMap();
            } catch (error) {
                console.error("Error fetching project code:", error);
            }
        }

        function getQueryParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        // üìç Set marker on the map
        function setMarkerAtLocation(location, name = "Selected Location") {
            // Clear existing marker if any
            if (marker) marker.setMap(null);

            // Create new marker
            marker = new google.maps.Marker({
                map: map,
                position: location
            });

            // Update selected coordinates
            selectedCoordinates.latitude = location.lat();
            selectedCoordinates.longitude = location.lng();
            selectedCoordinates.name = name;

            // Center map on new location
            map.panTo(location);
        }

        // Handle map click - place marker & fetch location details
        function handleMapClick(event) {
            const clickedLocation = event.latLng;
            const service = new google.maps.places.PlacesService(map);

            // Remove previous marker
            if (window.currentMarker) {
                window.currentMarker.setMap(null);
            }

            if (window.approveBtn) {
                window.approveBtn.remove();
            }

            if (approveBtn) {
                approveBtn.remove();
                approveBtn = null;
            }

            // Place a new marker
            window.currentMarker = new google.maps.Marker({
                position: clickedLocation,
                map: map,
                title: "Selected Location"
            });

            // Create a small green ‚úî button next to the marker
            approveBtn = document.createElement("button");
            approveBtn.innerHTML = "‚úî";
            approveBtn.classList.add("approve-marker-btn");
            // Append button to map container
            document.getElementById("map").appendChild(approveBtn);

            // Position the button correctly
            positionApproveButton(clickedLocation);

            // Click event for saving location
            approveBtn.onclick = approvePoint;

            // Reset selectedCoordinates
            selectedCoordinates = {
                latitude: clickedLocation.lat(),
                longitude: clickedLocation.lng(),
                name: ""
            };

            // Search for business
            const request = {
                location: clickedLocation,
                radius: 10,
                type: ["establishment"]
            };

            service.nearbySearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
                    const place = results[0];

                    service.getDetails(
                        { placeId: place.place_id, fields: ["name", "formatted_address", "geometry"] },
                        (placeDetails, status) => {
                            if (status === google.maps.places.PlacesServiceStatus.OK) {
                                selectedCoordinates.name = `${placeDetails.name}, ${placeDetails.formatted_address}`;
                                console.log("‚úÖ Business found:", selectedCoordinates.name);
                                window.currentMarker.setTitle(selectedCoordinates.name);
                            } else {
                                console.error("Error fetching place details:", status);
                                fallbackToGeocoder(clickedLocation);
                            }
                        }
                    );
                } else {
                    console.error("Nearby search failed:", status);
                    fallbackToGeocoder(clickedLocation);
                }
            });

            // Fallback method if nearbySearch fails
            function fallbackToGeocoder(location) {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ location }, (results, status) => {
                    if (status === "OK" && results[0]) {
                        selectedCoordinates.name = results[0].formatted_address;
                        console.log("‚úÖ Reverse geocoded:", selectedCoordinates.name);
                        window.currentMarker.setTitle(selectedCoordinates.name);
                    } else {
                        console.error("Geocoder failed:", status);
                    }
                });
            }
        }

        // Position the V button next to the marker when placed
        function positionApproveButton(location) {
            const overlay = new google.maps.OverlayView();
            overlay.draw = function () {};
            overlay.setMap(map);

            const projection = overlay.getProjection();
            const point = projection.fromLatLngToContainerPixel(location);

            // Keep the button in the same position relative to the marker
            approveBtn.style.position = "absolute";
            approveBtn.style.left = `${point.x}px`;
            approveBtn.style.top = `${point.y}px`;
        }


        // ‚úÖ Approve & Save selected location
        function approvePoint() {
            if (!selectedCoordinates.latitude || !selectedCoordinates.longitude) {
                alert("◊ê◊†◊ê ◊ë◊ó◊® ◊û◊ô◊ß◊ï◊ù ◊¢◊ú ◊î◊û◊§◊î.");
                return;
            }

            // Ensure name is always set to something meaningful
            /*
            if (!selectedCoordinates.name || selectedCoordinates.name === "Unknown Location") {
                selectedCoordinates.name = "Unnamed Location";
            }
            */
            const currentQuestion = questions[currentQuestionIndex];

            fetch("/save_location/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    latitude: selectedCoordinates.latitude,
                    longitude: selectedCoordinates.longitude,
                    name: selectedCoordinates.name,
                    location_type: currentQuestion.key,
                    project_code: projectCode
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log("üìå Saved:", data);
                Swal.fire({
                    icon: "success",
                    title: "◊™◊ï◊ì◊î!",
                    text: "◊î◊û◊ô◊ß◊ï◊ù ◊†◊©◊û◊®!",
                    confirmButtonText: "◊ê◊ô◊©◊ï◊®"
                });

                currentQuestionIndex++;
                updateQuestion();

                // Reset selected coordinates and clear marker
                selectedCoordinates = { latitude: null, longitude: null, name: null };
                if (window.currentMarker) window.currentMarker.setMap(null);
                document.getElementById("pac-input").value = "";
            })
            .catch(error => {
                console.error("‚ùå Error saving data:", error);
                alert("There was an error saving the location.");
            });
        }

        function updateQuestion() {
            if (currentQuestionIndex < questions.length) {
                document.getElementById("question-container").innerText = questions[currentQuestionIndex].text;
            } else {
                document.getElementById("question-container").innerText = "Thank You";
                document.getElementById("approve-btn").style.display = "none";
                setTimeout(() => {
                    try {
                        window.close(); // Try closing normally

                        // If close fails, force close by opening an empty page
                        window.open("about:blank", "_self").close();
                    } catch (e) {
                        console.error("Window close failed:", e);
                        window.location.href = "about:blank"; // As a last resort, redirect
                    }
                }, 2000);
            }
        }

        // Initialize Google Map
        async function initMap() {
            console.log("Initializing map...");

            // Fetch project details using the project code
            const project = await fetchProjectDetails(projectCode);
            if (!project || !project.address) return;

            // Geocode the project address
            const coordinates = await geocodeAddress(project.address);
            if (!coordinates) return;

            // Initialize the map
            
            map = new google.maps.Map(document.getElementById("map"), {
                //center: { lat: 31.7683, lng: 35.2137 }, // Default center
                center: coordinates,
                zoom: 14
            });
            
            window.initialMarker = new google.maps.Marker({
                position: coordinates,
                map: map,  // ‚úÖ Use `map` instead of `window.map`
                title: "Project Location",
                icon: {
                    url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                }
            });

            // Add click event listener to the map.
            map.addListener("click", handleMapClick);

            // Attach the search box
            const input = document.getElementById("pac-input");
            searchBox = new google.maps.places.SearchBox(input);

            updateQuestion();

            // Bias the SearchBox results towards the current map view
            /*
            map.addListener("bounds_changed", () => {
                searchBox.setBounds(map.getBounds());
            });
            */
            // Listen for search results
            searchBox.addListener("places_changed", () => {
                const places = searchBox.getPlaces();
                if (places.length === 0) return;
                const place = places[0];

                // Remove previous marker and button
                if (window.currentMarker) {
                    window.currentMarker.setMap(null);
                }
                if (approveBtn) {
                    approveBtn.remove();
                    approveBtn = null;
                }
                setMarkerAtLocation(place.geometry.location, place.name || "Searched Location");

                // Update the map to zoom and center on the place
                map.panTo(place.geometry.location);
                map.setZoom(15);

                // Store selected coordinates and name
                selectedCoordinates.latitude = place.geometry.location.lat();
                selectedCoordinates.longitude = place.geometry.location.lng();
                selectedCoordinates.name = place.name || "Unnamed Location";
                   
                // Create the small green ‚úî button
                approveBtn = document.createElement("button");
                approveBtn.innerHTML = "‚úî";
                approveBtn.classList.add("approve-marker-btn");
                document.getElementById("map").appendChild(approveBtn);
                
                // Position the button at the marker location
                positionApproveButton(place.geometry.location);

                // Click event for saving location
                approveBtn.onclick = approvePoint;
            });

            // Click event for saving location
            approveBtn.onclick = approvePoint;

            // Center map on the searched location
            map.panTo(place.geometry.location);
            map.setZoom(15);

            // Add event listener for approve button
            document.getElementById("approve-btn").addEventListener("click", approvePoint);
         
        }

        async function fetchProjectDetails(code) {
            try {
                // Fetch project details from the backend
                const response = await fetch(`/get_project/${code}`);
                //const response = await fetch(`http://127.0.0.1:8000/get_project/${code}`);  //For Debug
                if (!response.ok) throw new Error("Failed to fetch project details.");
                return await response.json();
            } catch (error) {
                console.error("Error fetching project details:", error);
                document.getElementById("error-message").style.display = "block";
                document.getElementById("error-message").textContent = "Failed to fetch project details. Please try again.";
                return null;
            }
        }

        async function geocodeAddress(address) {
            try {
                // Use the Google Geocoding API to get coordinates
                const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=AIzaSyActDT3BMeqymgsIrLQb6KgfL83k63caQY`);
                const data = await response.json();
                if (data.status === "OK" && data.results.length > 0) {
                    return data.results[0].geometry.location; // { lat, lng }
                } else {
                    throw new Error(data.error_message || "Address not found.");
                }
            } catch (error) {
                console.error("Error geocoding address:", error);
                document.getElementById("error-message").style.display = "block";
                document.getElementById("error-message").textContent = "Unable to locate the project address. Please check the details.";
                return null;
            }
        }

        // Fetch the latest project code and initialize map
        document.addEventListener('DOMContentLoaded', fetchProjectCode);
        
    </script>
<!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyActDT3BMeqymgsIrLQb6KgfL83k63caQY&libraries=places&callback=initMap"></script> -->    
 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyActDT3BMeqymgsIrLQb6KgfL83k63caQY&libraries=places"></script>
</body>
</html>