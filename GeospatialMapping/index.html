<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps with Questions</title>

    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #question-container {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            padding: 10px;
            background-color: #f8f9fa;
            z-index: 1;
        }
        #map { height: 85vh; width: 100%; position: relative; }
        #approve-btn {
            position: absolute;
            bottom: 3px;
            left: 52%;
            transform: translateX(-50%);
            background-color: #00BFFF;
            color: black;
            border: none;
            padding: 10px 20px;
            font-size: 20px;
            cursor: pointer;
            border-radius: 5px;
            z-index: 2;
        }
        #search-box {
            position: absolute;
            top: 50px;
            right: 0px;
            z-index: 10;
            background-color: white;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 24px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #search-box input {
            border: none;
            outline: none;
            padding: 2px 10px;
            font-size: 17px;
            width: 180px;
            font-family: Arial, sans-serif;
            border-radius: 20px;
        }
        #search-box input::placeholder {
            color: #aaa;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Question Container -->
    <div id="question-container">Loading...</div>

    <!-- Search Box -->
    <div id="search-box">
        <input id="pac-input" type="text" placeholder="Google חיפוש במפות">
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Approve Button -->
    <button id="approve-btn"> הוספת המיקום</button>

    <div class="error-message" id="error-message" style="display: none;"></div>

    <script>
        const questions = [
            { key: "FOOD", text: "?איפה אתם עושים קניות של מוצרי מזון" },
            { key: "FASHION", text: "?איפה אתם קונים בגדים" },
            { key: "NIGHTLIFE_AND_FUN", text: "?איפה אתם יוצאים לבלות" },
            { key: "KINDERGARTEN", text: "?איפה הגן ילדים" },
            { key: "SCHOOL", text: "?איפה הבית ספר" },
            { key: "RELIGION", text: "?איפה הבית כנסת" }
        ];

        let currentQuestionIndex = 0;
        let map, marker = null;
        let searchBox;
        let selectedCoordinates = { latitude: null, longitude: null, name: null };
        let projectCode = null; // Initialize as null


        async function fetchProjectCode() {
            try {
                projectCode = getQueryParameter('projectCode');
                if (!projectCode) {
                    alert("Error: Missing project code. Please contact the administrator.");
                    throw new Error("Missing project code in URL");
                }
                // Initialize the map after fetching project code
                initMap();
            } catch (error) {
                console.error("Error fetching project code:", error);
            }
        }

        function getQueryParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        function updateQuestion() {
            if (currentQuestionIndex < questions.length) {
                document.getElementById("question-container").innerText = questions[currentQuestionIndex].text;
            } else {
                document.getElementById("question-container").innerText = "Thank You";
                document.getElementById("approve-btn").style.display = "none";
                 setTimeout(() => {
                    // Close the page or redirect after a short delay
                    window.close(); // Attempt to close the window
                }, 2000); // Wait 2 seconds before closing
            }
        }

        function setMarkerAtLocation(location, name = "Selected Location") {
            // Clear existing marker if any
            if (marker) {
                marker.setMap(null);
            }

            // Create new marker
            marker = new google.maps.Marker({
                map: map,
                position: location
            });

            // Update selected coordinates
            selectedCoordinates.latitude = location.lat();
            selectedCoordinates.longitude = location.lng();
            selectedCoordinates.name = name;

            // Center map on new location
            map.panTo(location);
        }

        function handleMapClick(event) {
            const clickedLocation = event.latLng;

            // Initialize PlacesService
            const service = new google.maps.places.PlacesService(map);

            // Search for places near the clicked location
            const request = {
                location: clickedLocation,
                radius: 50, // Search within 50 meters for high accuracy
            };

            service.nearbySearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
                    // Use the first result's place_id to fetch detailed info
                    const placeId = results[0].place_id;

                    const detailsRequest = {
                        placeId: placeId,
                        fields: ["name", "formatted_address", "geometry"], // Request specific fields
                    };

                    service.getDetails(detailsRequest, (place, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            // Set marker and capture business details
                            setMarkerAtLocation(place.geometry.location, place.name);

                            // Update selectedCoordinates with the business details
                            selectedCoordinates.latitude = place.geometry.location.lat();
                            selectedCoordinates.longitude = place.geometry.location.lng();
                            selectedCoordinates.name = place.name;
                        } else {
                            console.error("Failed to get place details:", status);
                        }
                    });
                } else {
                    console.error("No nearby places found. Attempting reverse geocoding...");

                    // Fallback to reverse geocoding if no business is found
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ location: clickedLocation }, (results, status) => {
                        if (status === "OK" && results[0]) {
                            const locationName = results[0].formatted_address;
                            setMarkerAtLocation(clickedLocation, locationName);

                            selectedCoordinates.latitude = clickedLocation.lat();
                            selectedCoordinates.longitude = clickedLocation.lng();
                            selectedCoordinates.name = locationName; // Default to address
                        } else {
                            setMarkerAtLocation(clickedLocation, "Selected Location");
                        }
                    });
                }
            });
        }


        function approvePoint() {
            if (!selectedCoordinates.latitude || !selectedCoordinates.longitude || !selectedCoordinates.name) {
                alert("אנא בחר מיקום על המפה.");
                return;
            }

            const currentQuestion = questions[currentQuestionIndex];

            fetch("/save_location/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    latitude: selectedCoordinates.latitude,
                    longitude: selectedCoordinates.longitude,
                    name: selectedCoordinates.name,
                    location_type: currentQuestion.key,
                    project_code: projectCode,
                }),
            })
                .then((response) => response.json())
                .then((data) => {
                    console.log("Saved:", data);
                    Swal.fire({
                        icon: "success",
                        title: "תודה!",
                        text: "המיקום נשמר!",
                        confirmButtonText: "אישור",
                    });

                    currentQuestionIndex++;
                    updateQuestion();

                    // Reset selected coordinates and clear marker
                    selectedCoordinates = { latitude: null, longitude: null, name: null };
                    if (marker) marker.setMap(null);
                    document.getElementById("pac-input").value = "";
                })
                .catch((error) => {
                    console.error("Error saving data:", error);
                    alert("There was an error saving the location.");
                });
        }


        // Fetch the latest project code and initialize map
        document.addEventListener('DOMContentLoaded', fetchProjectCode);


        async function fetchProjectDetails(code) {
            try {
                // Fetch project details from the backend
                const response = await fetch(`/get_project/${code}`);
                //const response = await fetch(`http://127.0.0.1:8000/get_project/${code}`);  //For Debug
                if (!response.ok) throw new Error("Failed to fetch project details.");
                return await response.json();
            } catch (error) {
                console.error("Error fetching project details:", error);
                document.getElementById("error-message").style.display = "block";
                document.getElementById("error-message").textContent = "Failed to fetch project details. Please try again.";
                return null;
            }
        }

        async function geocodeAddress(address) {
            try {
                // Use the Google Geocoding API to get coordinates
                const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=AIzaSyActDT3BMeqymgsIrLQb6KgfL83k63caQY`);
                const data = await response.json();
                if (data.status === "OK" && data.results.length > 0) {
                    return data.results[0].geometry.location; // { lat, lng }
                } else {
                    throw new Error(data.error_message || "Address not found.");
                }
            } catch (error) {
                console.error("Error geocoding address:", error);
                document.getElementById("error-message").style.display = "block";
                document.getElementById("error-message").textContent = "Unable to locate the project address. Please check the details.";
                return null;
            }
        }


        // Add async to initMap
        async function initMap() {
            console.log("Initializing map...");

            // Fetch project details using the project code
            const project = await fetchProjectDetails(projectCode);
            if (!project || !project.address) return;

            // Geocode the project address
            const coordinates = await geocodeAddress(project.address);
            if (!coordinates) return;

            // Initialize the map
            /*map = new google.maps.Map(document.getElementById("map"), {
                //center: { lat: 31.7683, lng: 35.2137 }, // Default center
                center: coordinates,
                zoom: 14
            });
            */
            if (!window.map) {
                window.map = new google.maps.Map(document.getElementById("map"), {
                    center: coordinates,
                    zoom: 14
                });

                // Add the first marker only if it doesn't exist
                if (!window.initialMarker) {
                    window.initialMarker = new google.maps.Marker({
                        position: coordinates,
                        map: window.map,
                        title: "Project Location",
                        icon: {
                            url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png" // Custom icon for differentiation
                        }
                    });
                }
            }

            // Add click event listener to the map.
            map.addListener("click", handleMapClick);

            // Attach the search box
            const input = document.getElementById("pac-input");
            searchBox = new google.maps.places.SearchBox(input);

            // Bias the SearchBox results towards the current map view
            map.addListener("bounds_changed", () => {
                searchBox.setBounds(map.getBounds());
            });

            // Listen for search results
            searchBox.addListener("places_changed", () => {
                const places = searchBox.getPlaces();
                if (places.length === 0) return;


                setMarkerAtLocation(place.geometry.location, place.name || "Searched Location");

                const place = places[0];

                setMarkerAtLocation(place.geometry.location, place.name || "Searched Location");

                // Update the map to zoom and center on the place
                map.panTo(place.geometry.location);
                map.setZoom(15);

                // Store selected coordinates and name
                selectedCoordinates.latitude = place.geometry.location.lat();
                selectedCoordinates.longitude = place.geometry.location.lng();
                selectedCoordinates.name = place.name || "Unnamed Location";
            });

            // Add event listener for map clicks
            map.addListener("click", handleMapClick);

            // Add event listener for approve button
            document.getElementById("approve-btn").addEventListener("click", approvePoint);

            updateQuestion();
        }

    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyActDT3BMeqymgsIrLQb6KgfL83k63caQY&libraries=places&callback=initMap"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>