<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps with Questions</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyActDT3BMeqymgsIrLQb6KgfL83k63caQY&libraries=places"></script>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #question-container {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            padding: 10px;
            background-color: #f8f9fa;
            z-index: 1;
        }
        #map { height: 85vh; width: 100%; position: relative; }
        #approve-btn {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #00FF00;
            color: black;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            z-index: 2;
        }
        #search-box {
            position: absolute;
            top: 50px;
            right: 70px;
            z-index: 10;
            background-color: white;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 24px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #search-box input {
            border: none;
            outline: none;
            padding: 5px 10px;
            font-size: 14px;
            width: 250px;
            font-family: Arial, sans-serif;
            border-radius: 20px;
        }
        #search-box input::placeholder {
            color: #aaa;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Question Container -->
    <div id="question-container">Loading...</div>

    <!-- Search Box -->
    <div id="search-box">
        <input id="pac-input" type="text" placeholder="Google חיפוש במפות">
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Approve Button -->
    <button id="approve-btn"> הוספת המיקום</button>

    <script>
        const questions = [
            { key: "FOOD", text: "?איפה אתם עושים קניות של מוצרי מזון" },
            { key: "FASHION", text: "?איפה אתם קונים בגדים" },
            { key: "NIGHTLIFE_AND_FUN", text: "?איפה אתם יוצאים לבלות" },
            { key: "KINDERGARTEN", text: "?איפה הגן ילדים" },
            { key: "SCHOOL", text: "?איפה הבית ספר" },
            { key: "RELIGION", text: "?איפה הבית כנסת" }
        ];

        let currentQuestionIndex = 0;
        let map, marker = null;
        let searchBox;
        let selectedCoordinates = { latitude: null, longitude: null, name: null };

        function initMap() {
            // Initialize the map
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 31.7683, lng: 35.2137 }, // Default center
                zoom: 8
            });

            // Attach the search box
            const input = document.getElementById("pac-input");
            searchBox = new google.maps.places.SearchBox(input);

            // Bias the SearchBox results towards the current map view
            map.addListener("bounds_changed", () => {
                searchBox.setBounds(map.getBounds());
            });

            // Listen for search results
            searchBox.addListener("places_changed", () => {
                const places = searchBox.getPlaces();
                if (places.length === 0) return;

                // Clear old marker
                if (marker) marker.setMap(null);

                const place = places[0];

                // Set the marker at the selected place
                marker = new google.maps.Marker({
                    map,
                    position: place.geometry.location
                });

                // Update the map to zoom and center on the place
                map.panTo(place.geometry.location);
                map.setZoom(15);

                // Store selected coordinates and name
                selectedCoordinates.latitude = place.geometry.location.lat();
                selectedCoordinates.longitude = place.geometry.location.lng();
                selectedCoordinates.name = place.name || "Unnamed Location";
            });

            // Listen for map clicks
            map.addListener("click", (event) => {
                const placesService = new google.maps.places.PlacesService(map);

                // Search for nearby places
                placesService.nearbySearch(
                    { location: event.latLng, radius: 10 }, // Search nearby locations within a 10m radius
                    (results, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
                            const place = results[0]; // Get the nearest place

                            // Fetch full place details
                            placesService.getDetails(
                                { placeId: place.place_id },
                                (placeDetails, detailsStatus) => {
                                    if (detailsStatus === google.maps.places.PlacesServiceStatus.OK) {
                                        // Get the business name
                                        const businessName = placeDetails.name || "Unnamed Business";
                                        const formattedAddress = placeDetails.formatted_address || "Address not available";

                                        // Combine the business name and full address
                                        const fullAddress = `${businessName}, ${formattedAddress}`;

                                        placeMarker(event.latLng, fullAddress); // Save as the name
                                    } else {
                                        // Fallback if details retrieval fails
                                        placeMarker(event.latLng, "Unnamed Business");
                                    }
                                }
                            );
                        } else {
                            // If no place is found, prompt user to enter a name
                            const customName = prompt("Enter a name for this location:");
                            if (customName) {
                                placeMarker(event.latLng, customName);
                            }
                        }
                    }
                );
            });




            document.getElementById("approve-btn").addEventListener("click", approvePoint);
            updateQuestion();
        }

        function updateQuestion() {
            if (currentQuestionIndex < questions.length) {
                document.getElementById("question-container").innerText = questions[currentQuestionIndex].text;
            } else {
                document.getElementById("question-container").innerText = "Thank You";
                document.getElementById("approve-btn").style.display = "none";
            }
        }

        function placeMarker(location, name) {
            if (marker) marker.setMap(null);

            marker = new google.maps.Marker({
                position: location,
                map: map
            });

            selectedCoordinates.latitude = location.lat();
            selectedCoordinates.longitude = location.lng();
            selectedCoordinates.name = name;
        }

        function approvePoint() {
            if (!selectedCoordinates.latitude || !selectedCoordinates.longitude || !selectedCoordinates.name) {
                alert("Please select a point and provide a name.");
                return;
            }

            const currentQuestion = questions[currentQuestionIndex];

            fetch("http://127.0.0.1:8000/save_location/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    latitude: selectedCoordinates.latitude,
                    longitude: selectedCoordinates.longitude,
                    name: selectedCoordinates.name,
                    location_type: currentQuestion.key
                }),
            })
            .then(response => response.json())
            .then(data => {
                console.log("Saved:", data);
                alert(`Location for "${currentQuestion.text}" saved.`);
                currentQuestionIndex++;
                selectedCoordinates = { latitude: null, longitude: null, name: null }; // Reset
                updateQuestion();
            })
            .catch(error => console.error("Error saving data:", error));
        }

        window.onload = initMap;
    </script>
</body>
</html>
